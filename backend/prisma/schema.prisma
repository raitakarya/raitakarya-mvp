generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  WORKER
  FARMER
  ADMIN
}

enum JobStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ApplicationStatus {
  PENDING
  ACCEPTED
  REJECTED
  COMPLETED
}

enum PaymentStatus {
  PENDING
  HELD_IN_ESCROW
  RELEASED
  REFUNDED
  FAILED
}

model User {
  id              String   @id @default(uuid())
  phone           String   @unique
  name            String
  email           String?  @unique
  password        String
  role            UserRole
  profileImage    String?
  whatsappNumber  String?
  acceptedTermsAt DateTime?
  isVerified      Boolean  @default(false)
  workerProfile   WorkerProfile?
  applications    Application[]
  receivedRatings Rating[] @relation("ReceivedRatings")
  farmerProfile   FarmerProfile?
  postedJobs      Job[]
  givenRatings    Rating[] @relation("GivenRatings")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  @@index([phone])
  @@index([email])
}

model WorkerProfile {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  skills          String[]
  languages       String[]
  location        String
  latitude        Float?
  longitude       Float?
  experienceYears Int      @default(0)
  certifications  String[]
  totalEarnings   Float    @default(0)
  totalJobs       Int      @default(0)
  averageRating   Float    @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model FarmerProfile {
  id            String   @id @default(uuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  farmName      String
  farmLocation  String
  latitude      Float?
  longitude     Float?
  farmSize      Float?
  cropTypes     String[]
  totalSpent    Float    @default(0)
  totalJobsPosted Int    @default(0)
  averageRating Float    @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Job {
  id            String    @id @default(uuid())
  farmerId      String
  farmer        User      @relation(fields: [farmerId], references: [id])
  title         String
  description   String
  jobType       String
  location      String
  latitude      Float?
  longitude     Float?
  photos        String[]
  wagePerDay    Float
  duration      Int
  workersNeeded Int
  requiredSkills String[]
  startDate     DateTime
  endDate       DateTime?
  status        JobStatus @default(OPEN)
  applications  Application[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  @@index([farmerId])
  @@index([status])
  @@index([jobType])
}

model Application {
  id          String            @id @default(uuid())
  jobId       String
  job         Job               @relation(fields: [jobId], references: [id], onDelete: Cascade)
  workerId    String
  worker      User              @relation(fields: [workerId], references: [id])
  status      ApplicationStatus @default(PENDING)
  message     String?
  payment     Payment?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  @@unique([jobId, workerId])
  @@index([jobId])
  @@index([workerId])
  @@index([status])
}

model Payment {
  id              String        @id @default(uuid())
  applicationId   String        @unique
  application     Application   @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  amount          Float
  status          PaymentStatus @default(PENDING)
  razorpayOrderId   String?     @unique
  razorpayPaymentId String?     @unique
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  releasedAt      DateTime?
  @@index([applicationId])
  @@index([status])
}

model Rating {
  id          String   @id @default(uuid())
  reviewerId  String
  reviewer    User     @relation("GivenRatings", fields: [reviewerId], references: [id])
  revieweeId  String
  reviewee    User     @relation("ReceivedRatings", fields: [revieweeId], references: [id])
  rating      Int
  comment     String?
  createdAt   DateTime @default(now())
  @@unique([reviewerId, revieweeId])
  @@index([reviewerId])
  @@index([revieweeId])
}
